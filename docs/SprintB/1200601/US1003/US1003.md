# US 1003
=======================================


# 1. Requisitos



**User Story:** As Sales Clerk, I want to register a new customer.



* There are three direct ways to create a new customer:
  * The customer accesses the application (without being authenticated) and proceeds to
    his/herself registration. The customer account needs to be further activated, otherwise
    the customer cannot access the system.
  * The registration is manually performed by a clerk. No account activation is required
  * Alternatively, customers info might be imported from a text file generated by an external
    system. Multiple text file formats need to be supported (e.g.: CSV, XML).


# 2. Análise


##Text File Generation

  * Multiple text file formats needs to be supported (eg.: CSV,XML)
  * Sales Clerk is responsible for importing the clients.
  * The System must notice the rows who don't follow the format, if  that happens, it must inform the user and skip to the next row.
  * The program should notify the customer that his account was created and send the password. 
  * The program should also send ,to the customer, a link able to change the customer password. 

![US1003SSD](SSD10032.svg)

##Sales Clerk Manually Creation

  * The registration is manually performed by a clerk. 
  * If the Sales Clerk wrongly inputs the customer information, the system must ask to input that same information again.
  * No account activation is required.
  * The program should notify the customer that his account was created and send the password.
  * The program should also send ,to the customer, a link able to change the customer password.

![US1003SSD](US1003.svg)

##Domain Model

![US1003DM](MD%201003.svg)

##Regarding the Customer

* **Customer Responsability** : responsible to keep his/her own personal information updated, to create orders and
  follow their status and answer a survey questionnaire when requested and at his/her willing. 
* The minimum required information is its name, a valid Value-Added Tax (VAT) identifier, an email address, and a phone number.

* Optionally, customers might state their birthdate and gender and have/manage several billing and delivering postal addresses.

* The delivering postal  addresses should be kept updated  by customer during the ordering process, namely while they are concluding a new
  clientOrder.
* Every customer also has a unique identifier that is automatically generated by the system at
   the customer registration time.
* Customers and other kind of users frequently access the system to browse and search for products

# 3. Design

*Nesta secção a equipa deve descrever o design adotado para satisfazer a funcionalidade. Entre outros, a equipa deve apresentar diagrama(s) de realização da funcionalidade, diagrama(s) de classes, identificação de padrões aplicados e quais foram os principais testes especificados para validar a funcionalidade.*

*Para além das secções sugeridas, podem ser incluídas outras.*


## 3.1. Realização da Funcionalidade

###Sales Clerk Manual Customer Creation

![US1003SSD](US1003%20SD.svg)

###Sales Clerk Import Customer File
![US10032SD](SD10032.svg)

## 3.2. Diagrama de Classes

###Sales Clerk Manual Customer Creation

![US1003CD](CD%201%20US1003.svg)

###Sales Clerk Import Customer File 
![US1003CD](CD10003%202.svg)

## 3.3. Padrões Aplicados

###Sales Clerk Manual Customer Creation

* Information Expert
* Tell, don't ask
* Single Responsibility Principle
* Interface Segregation Principle
* DDD (Persistence Ignorance, Entity, Value Object, Domain Service, Aggregate, Domain Event, Observer)
* Repositories were used.
* GRASP (High cohesion, Low coupling)
* For this project we will maintain the UI-Controller interaction, the UI will interact with the
user, requesting information about the object eapli.base.customermanagement.domain.Customer which will then be sent to the Controller.
* The Controller will call the Services that are responsible for the Customer creation.
* The CustomerRepository class will be responsible to add the object into the database.
* A Customer Builder was implemented which is reponsible for building the Customer object.



## 3.4. Tests

**Test 1:** Create a valid Customer using CustomerBuilder

    private Email email1 = new Email("ola@gmail.com");
    private Email email2 = new Email("sadas@gmail.com");
    private Gender gender1 = new Gender("Male");
    private Gender gender2 = new Gender("Female");
    private BirthDate birthDate1 = new BirthDate(new Date("11/1/2001"));
    private BirthDate birthDate2 = new BirthDate(new Date("2/2/2002"));
    private Name name2 = new Name("Tiago Ferreira");
    private Name name3 = new Name("Ambrosio dos Brosios");
    private VAT VAT1 = new VAT(2);
    private VAT VAT2 = new VAT(3);
    private PhoneNumber phoneNumber1 = new PhoneNumber(123,123456789);
    private PhoneNumber phoneNumber2 = new PhoneNumber(333,111456789);
    private Address address1 = new Address("aa",12,"aa","aa","aa");
    private Address address2 = new Address("aa",13,"sad","ad","ds");


    private Customer customer1 = new Customer(phoneNumber1, birthDate1, name2, gender1, VAT1, email1,address1);
    private Customer customer2 = new Customer(phoneNumber2, birthDate2, name3, gender2, VAT2, email2,address2);

    private CustomerBuilder customerBuilder = new CustomerBuilder();

    @Test
    public void buildTest(){

        Customer customer = customerBuilder.number(phoneNumber1).brithDate(birthDate1).named(name2)
                .gender(gender1).vat(VAT1).email(email1).build();

        assertEquals(birthDate1,customer.birthDate());
        assertEquals(name2,customer.name());
        assertEquals(gender1,customer.gender());
        assertEquals(gender1,customer.gender());
        assertEquals(VAT1,customer.vat());
        assertEquals(email1,customer.email());
    }


    }

**Test 2:** Create a valid Customer

    private Email email1 = new Email("ola@gmail.com");
    private Email email2 = new Email("sadas@gmail.com");
    private Gender gender1 = new Gender("Male");
    private Gender gender2 = new Gender("Female");
    private BirthDate birthDate1 = new BirthDate(new Date("11/1/2001"));
    private BirthDate birthDate2 = new BirthDate(new Date("2/2/2002"));
    private Name name2 = new Name("Tiago Ferreira");
    private Name name3 = new Name("Ambrosio dos Brosios");
    private VAT VAT1 = new VAT(2);
    private VAT VAT2 = new VAT(3);
    private PhoneNumber phoneNumber1 = new PhoneNumber(123,123456789);
    private PhoneNumber phoneNumber2 = new PhoneNumber(333,111456789);
    private Address address1 = new Address("aa",11,"aa","aa","aa");
    private Address address2 = new Address("aa",12,"bb","cc","dd");

    private Customer customer1 = new Customer(phoneNumber1, birthDate1, name2, gender1, VAT1, email1,address1);
    private Customer customer2 = new Customer(phoneNumber2, birthDate2, name3, gender2, VAT2, email2,address2);

    @Test
    public void simpleCustomerTest(){

        CustomerBuilder customerBuilder = new CustomerBuilder();

        customerBuilder.address(address1).brithDate(birthDate1)
                .number(phoneNumber1).named(name2).gender(gender1)
                .email(email1).vat(VAT1).build();

        Customer customer = customerBuilder.build();

        assertNotNull(customer);
        assertEquals(customer.email(),email1);
        assertEquals(customer.gender(),gender1);
        assertEquals(customer.birthDate(),birthDate1);
        assertEquals(customer.vat(),VAT1);
        assertEquals(customer.phoneNumber(),phoneNumber1);
    }

**Test 3:** Compare two Customers

    @Test
    public void sameAs(){

        CustomerBuilder customerBuilder = new CustomerBuilder();
        CustomerBuilder customerBuilder2 = new CustomerBuilder();

        customerBuilder.address(address1).brithDate(birthDate1)
                .number(phoneNumber1).named(name2).gender(gender1)
                .email(email1).vat(VAT1).build();

        customerBuilder2.address(address2).brithDate(birthDate2)
                .number(phoneNumber2).named(name3).gender(gender2)
                .email(email2).vat(VAT2).build();

        Customer customer1 = customerBuilder.build();
        Customer customer2 = customerBuilder2.build();

        assertEquals(false,customer1.equals(customer2));
        assertEquals(true,customer1.equals(customer1));
    }

**Test 4:** Comparing birthdates


    private BirthDate birthDate1 = new BirthDate(new Date("11/1/2001"));
    private BirthDate birthDate2 = new BirthDate(new Date("2/2/2002"));
    private BirthDate birthDate3 = new BirthDate(new Date("11/1/2001"));

    @Test
    public void compareTo(){


        assertEquals(0, birthDate1.compareTo(birthDate3));
        assertEquals(-1, birthDate1.compareTo(birthDate2));
    }

**Test 5:** Checking if the emails have the correct format


    private Email email1 = new Email("ola@gmail.com");
    private Email email2 = new Email("sadas@gmail.com");
    private Email email3 = new Email("ola@gmail.com");

    @Test
    public void checkEmail() {

        Email email;
        String expectedMessage = "Incorrect Email Format!";
        String actualMessage = null;
        String actualMessage2 = null;

        try {
            email = new Email("ASdassdasasad");
        } catch (IllegalArgumentException ex) {
            actualMessage = ex.getMessage();
        }


        try {
            email = new Email("ola@gmail.com");
        } catch (IllegalArgumentException ex) {
            actualMessage2 = ex.getMessage();
        }

        assertEquals(expectedMessage, actualMessage);
        assertNotEquals(expectedMessage, actualMessage2);

    }

**Test 6:** Check if gender is a Male,Female or Other


    private Gender gender1 = new Gender("Male");
    private Gender gender2 = new Gender("Female");
    private Gender gender3 = new Gender("Male");


    @Test
    public void checkGender() {


        Gender gender4 = new Gender("male");
        Gender gender5 = new Gender("female");
        Gender gender6 = new Gender("other");
        String expectedMessage = "Gender does not exist! Please input Male,Female or Other";
        String actualMessage = null;
        String actualMessage2 = null;

        try {

            Gender gender = new Gender("AAAA");
        } catch (IllegalArgumentException ex) {
            actualMessage = ex.getMessage();
        }

        try {

            Gender gender = new Gender("Male");
        } catch (IllegalArgumentException ex) {
            actualMessage2 = ex.getMessage();
        }


        assertEquals(expectedMessage, actualMessage);
        assertNotEquals(expectedMessage, actualMessage2);
        assertEquals("Male", gender4.gender());
        assertEquals("Female", gender5.gender());
        assertEquals("Other", gender6.gender());
    }

**Test 7 and 8:** Checking the format of the phone number indicatives and the number itself.

    private PhoneNumber phoneNumber1 = new PhoneNumber(123,123456789);
    private PhoneNumber phoneNumber2 = new PhoneNumber(333,111456789);
    private PhoneNumber phoneNumber3 = new PhoneNumber(123,123456789);

    @Test
    public void checkIndicatives(){

        String message = "Incorrect indicative format!";
        String actualMessage = null;

        try{
            PhoneNumber phoneNumber = new PhoneNumber(1,123456789);
        }catch (IllegalArgumentException ex){
            actualMessage = ex.getMessage();
        }
        
        assertEquals(message,actualMessage);
    }

    @Test
    public void checkPhoneNumber(){

        String message = "Incorrect Phone Number format!";
        String actualMessage = null;

        try{
            PhoneNumber phoneNumber = new PhoneNumber(123,16789);
        }catch (IllegalArgumentException ex){
            actualMessage = ex.getMessage();
        }

        assertEquals(message,actualMessage);
    }

# 4. Implementation

##Customer  

    @Entity
    public class Customer implements AggregateRoot<Long> {

    private static final long serialVersionUID = 1L;
    @Version
    private Long version;
    @Id
    @GeneratedValue(strategy = GenerationType.AUTO)
    private Long customerId;

    @Column(nullable = false)
    private PhoneNumber customerPhoneNumber;
    @Column(nullable = false)
    private Gender gender;
    @Column(nullable = false)
    private BirthDate birthDate;
    @Column(nullable = false)
    private Name name;
    @Column(nullable = false)
    private VAT VAT;
    @Column(nullable = false)
    private Email email;
    @Column(nullable = false)
    private Address address;

    public Customer(final PhoneNumber customerPhoneNumber, final BirthDate birthDate,
                    final Name name, final Gender gender,
                    final VAT VAT, final Email email,Address address) throws IllegalArgumentException {

        this.customerPhoneNumber = customerPhoneNumber;
        this.gender = gender;
        this.birthDate = birthDate;
        this.name = name;
        this.VAT = VAT;
        this.email = email;
        this.address = address;
    }

    public Customer() {

    }

    public PhoneNumber phoneNumber(){return this.customerPhoneNumber;}

    public Gender gender(){return  this.gender;}

    public BirthDate birthDate(){return this.birthDate;}

    public Name name(){return this.name;}

    public VAT vat(){return this.VAT;}

    public Email email(){return this.email;}

    @Override
    public int hashCode() {
        return DomainEntities.hashCode(this);
    }

    @Override
    public boolean sameAs(Object other) {

        if(! (other instanceof Customer)){
            return false;
        }

        final Customer that =(Customer) other;

        if(this == that){
            return true;
        }

        return identity().equals(that.identity()) && gender.equals(that.gender) &&
                name.equals(that.name) &&
                email.equals(that.email) &&
                VAT.equals(VAT) &&
                customerPhoneNumber.equals(customerPhoneNumber) &&
                birthDate.equals(that.birthDate);
    }

    @Override
    public Long identity() {
        return customerId;
    }


    }

##CreateCustomerUI

    public class CreateCustomerUI extends AbstractUI {

    private final CreateCustomerController createCustomerController = new CreateCustomerController();
    private static final Logger LOGGER = LoggerFactory.getLogger(RegisterCategoryUI.class);
    //private final SearchProductService searchProductService = new SearchProductService();
    //private final SearchCustomerService searchCustomerService = new SearchCustomerService();

    @Override
    protected boolean doShow() {

        int option = Console.readInteger("1. Manually input the Customer   2.Import Customer(s) from a file");

        if (option == 1) {

            try {


                //System.out.println(searchProductService.searchProduct(Long.valueOf(5)).identity());
                //System.out.println(searchCustomerService.searchCustomerService(Long.valueOf(3)).identity());

                //Value Objects
                Gender gender = null;
                boolean userPassVerify = false;
                Email customerEmail = null;
                String userName = null;
                String password = null;
                String email = null;

                //Verifiers
                boolean verifyGender = false;
                boolean verifyEmail = false;

                do {
                    try {
                        email = Console.readLine("Customer email:");
                        customerEmail = new Email(email);

                        verifyEmail = true;

                    } catch (IllegalArgumentException ex) {
                        LOGGER.error(ex.getMessage());
                    }

                } while (!verifyEmail);


                do {
                    try {
                        userName = Console.readLine("New username:");

                        if (userName.isEmpty()) {
                            throw new IllegalArgumentException("Please do not input an empty username!");
                        }
                        password = Console.readLine("New password:");
                        if (password.isEmpty()) {
                            throw new IllegalArgumentException("Please do not input an password!");
                        }

                    } catch (IllegalArgumentException ex) {
                        LOGGER.error(ex.getMessage());
                    }
                } while (userName.isEmpty()|| password.isEmpty());


                Name name = new Name(Console.readLine("What is the Customer name?"));
                String firstName = Console.readLine("What is the Customer first name?");
                String lastName = Console.readLine("What is the Customer last name?");
                VAT VAT = new VAT(Console.readInteger("What is the Customer VAT?"));

                Address address = new Address(Console.readLine("Billing Address?"), Console.readInteger("Customer Door Number?"),
                        Console.readLine("Customer Postal Code?"),Console.readLine("Customer city?"),
                        Console.readLine("Customer country?"));

                do {
                    try {
                        gender = new Gender(Console.readLine("What is the Customer gender?"));
                        verifyGender = true;
                    } catch (IllegalArgumentException ex) {
                        LOGGER.error(ex.getMessage());
                    }
                } while (!verifyGender);



                BirthDate birthDate = new BirthDate(Console.readDate("When is the Customer birthday?"));
                PhoneNumber phoneNumber = new PhoneNumber(Console.readInteger("What is the Customer phone indicatives?"), Console.readLong("What is your phone number?"));
                final Set<Role> roles = new HashSet<>();
                roles.add(BaseRoles.CLIENT_USER);

                createCustomerController.registerCustomer(phoneNumber, birthDate, name, gender, VAT, customerEmail, userName, password, firstName, lastName, email, roles, Calendar.getInstance(), address);
            } catch (IllegalArgumentException ex) {

                if (ex.getMessage() != null) {
                    LOGGER.error(ex.getMessage());
                } else {

                    System.out.println("Incorrect Password Format! Please input at least an UpperCase letter and a number!");
                    createCustomerController.deleteCustomer();
                }
                return false;

            }
            System.out.println("Customer Registered with success!");
        } else if (option == 2) {

            try {
                String path = Console.readLine("Path for the customer and user file (must be in the same path):");
                createCustomerController.createCustomerByFile(path);
            } catch (FileNotFoundException e) {
                e.printStackTrace();
                return false;
            }
            catch (ArrayIndexOutOfBoundsException ex){
                LOGGER.error(ex.getMessage());
                return false;
            }

            System.out.println("Customer Registered with success!");
        } else {
            System.out.println("Registration Cancelled");
        }


        return true;
    }

    @Override
    public String headline() {
        return "Create new Customer";
    }
    }

##CreateCustomerController

    @UseCaseController
    public class CreateCustomerController {

        private final AuthorizationService authz = AuthzRegistry.authorizationService();
        private final CreateCustomerService createCustomerService = new CreateCustomerService();
        private final CreateUserService createUserService = new CreateUserService();
        private Customer customer = null;
        private final CreateCustomerByFileService createCustomerByFileService = new CreateCustomerByFileService();

        public Customer registerCustomer(final PhoneNumber customerPhoneNumber, final BirthDate birthDate,
                                         final Name name, final Gender gender,
                                         final VAT VAT, final Email customerEmail,
                                         final String username, final String password, final String firstName,
                                         final String lastName, final String email,
                                         final Set<Role> roles, final Calendar createdOn,
                                         final Address address){


                authz.ensureAuthenticatedUserHasAnyOf(BaseRoles.POWER_USER, BaseRoles.SALES_CLERK);


                customer = createCustomerService.registerCustomer(customerPhoneNumber, birthDate, name, gender, VAT,customerEmail,address);
                createUserService.createUser(username,password,firstName,lastName,email,roles,createdOn);


                return customer;
        }

        public boolean deleteCustomer(){
                final DeleteCustomerService deleteCustomerService = new DeleteCustomerService();
                deleteCustomerService.deleteCustomer(customer);
                return true;
        }

        public boolean createCustomerByFile(String path) throws FileNotFoundException {

                final Set<Role> roles = new HashSet<>();
                roles.add(BaseRoles.CLIENT_USER);
                List<String []> customerList = createCustomerByFileService.createCustomerByFile(new File(path));

                for(String [] customerArray : customerList){

                        createCustomerService.registerCustomer(new PhoneNumber(Integer.valueOf(customerArray[5]),Long.valueOf(customerArray[6]))
                        ,new BirthDate(new Date(customerArray[3])),new Name(customerArray[1])
                        ,new Gender(customerArray[2]),new VAT(Integer.valueOf(customerArray[4]))
                        ,new Email(customerArray[0]),new Address(customerArray[11],Integer.valueOf(customerArray[12]),customerArray[13],customerArray[14],customerArray[15]));
                        createUserService.createUser(customerArray[7],customerArray[8],customerArray[9]
                        ,customerArray[10],customerArray[0],roles,Calendar.getInstance());
                }

                return true;
        }

    }


##CreateCustomer Service

    @ApplicationService
    class CreateCustomerService {

    private final ClientRepository clientRepository = PersistenceContext.repositories().client();


    public Customer registerCustomer(final PhoneNumber customerPhoneNumber, final BirthDate birthDate,
                                     final Name name, final Gender gender, final VAT vat, final Email email,
                                     final Address address){



        final Customer customer = new CustomerBuilder()
                .brithDate(birthDate)
                .email(email)
                .gender(gender)
                .named(name)
                .number(customerPhoneNumber)
                .vat(vat)
                .address(address)
                .build();

        return clientRepository.save(customer);

    }

    }

##CreateUserService

    @ApplicationService
    public class CreateUserService {

    private final AddUserController theController = new AddUserController();

    public SystemUser createUser(final String username, final String password, final String firstName, final String lastName, final String email, final Set<Role> roles, final Calendar createdOn) {
        return theController.addUser(username, password, firstName, lastName, email, roles, createdOn);

    }
    }

##CustomerBuilder


    public class CustomerBuilder implements DomainFactory<Customer> {

    private Customer theCustomer;

    private PhoneNumber customerPhoneNumber;
    private Gender gender;
    private BirthDate birthDate;
    private Name name;
    private VAT VAT;
    private Email email;
    private Address address;

    public CustomerBuilder address(final Address address){
        this.address = address;
        return this;
    }

    public CustomerBuilder number(final PhoneNumber phoneNumber) {
        customerPhoneNumber = phoneNumber;
        return this;
    }


    public CustomerBuilder gender(final Gender gender){
        this.gender = gender;
        return this;
    }


    public CustomerBuilder brithDate(final BirthDate birthDate){
        this.birthDate = birthDate;
        return this;
    }


    public CustomerBuilder named(final Name name){
        this.name = name;
        return this;
    }


    public CustomerBuilder vat(final VAT vat){
        VAT = vat;
        return this;
    }


    public CustomerBuilder email(final Email email){
        this.email = email;
        return this;
    }

    private Customer buildOrThrow(){

        if(theCustomer != null){
            return theCustomer;
        }
        else if(customerPhoneNumber != null && name != null && VAT != null && email != null && gender != null && birthDate != null){
            theCustomer = new Customer(customerPhoneNumber, birthDate, name, gender, VAT, email,address);
            return theCustomer;
        }
        else{
            throw new IllegalStateException();
        }
    }

    @Override
    public Customer build() {
        final Customer ret = buildOrThrow();
        theCustomer = null;
        return ret;
    }
    }


# 5. Integração/Demonstração

*Nesta secção a equipa deve descrever os esforços realizados no sentido de integrar a funcionalidade desenvolvida com as restantes funcionalidades do sistema.*

# 6. Observações

*Nesta secção sugere-se que a equipa apresente uma perspetiva critica sobre o trabalho desenvolvido apontando, por exemplo, outras alternativas e ou trabalhos futuros relacionados.*

